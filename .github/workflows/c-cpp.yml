name: C/C++ CI (Build & Test)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build_radixgraph:
    name: Build GFE Driver for RadixGraph
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gcc-11 g++-11 libnuma-dev cmake zlib1g-dev \
            libpapi-dev libjemalloc-dev python3 libtbb-dev libevent-dev libboost-all-dev autoconf automake

      - name: Configure
        run: |
          export CC=gcc-11
          export CXX=g++-11
          git submodule update --init
          mkdir build && cd build
          autoreconf -iv ..

      - name: Compile RadixGraph library
        run: |
          export CC=gcc-11
          export CXX=g++-11
          cd library/radixgraph/RadixGraph
          git submodule update --init --recursive
          cmake -S . -DCMAKE_BUILD_TYPE=Release
          make -j2
          g++ optimizer.cpp -o optimizer -O3
          mv libRG.a ../../../
          mv optimizer ../../../
          cd ../../../

      - name: Build GFE Driver for RadixGraph
        run: |
          export CC=gcc-11
          export CXX=g++-11
          cd build
          ../configure --enable-optimize --disable-debug --with-radixgraph=../
          make clean && make -j2

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gfe-radixgraph-build
          path: |
            build/gfe_driver
            build/Makefile
            optimizer
            libRG.a
          if-no-files-found: error

  test_radixgraph:
    name: Test GFE Driver on LiveJournal Dataset (RadixGraph)
    runs-on: ubuntu-latest
    needs: build_radixgraph

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: gfe-radixgraph-build
          path: .

      - name: Install runtime dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y g++-11 wget libnuma-dev libtbb-dev libpapi-dev libjemalloc-dev python3 python3-pip
          pip3 install tqdm

      - name: Download LiveJournal dataset
        run: |
          python3 downloader.py --download-lj-only
          sed -i '/^#/d' datasets/*.txt
          sed -i -E 's/[[:space:]]+/ /g' datasets/*.txt
          mv datasets/com-lj.ungraph.txt datasets/com-lj.ungraph.el

      - name: Generate graph properties
        run: |
          g++ scripts/generate_property_files.cpp -o generate_property_files -O2
          ./generate_property_files datasets/com-lj.ungraph.el

      - name: Edge insertions and deletions (RadixGraph)
        run: |
          chmod +x build/gfe_driver optimizer
          sh scripts/run_random.sh radixgraph 4
      
      - name: Vertex insertions and deletions (RadixGraph)
        run: |
          g++ scripts/create_vertex_ops.cpp -o create_vertex_ops -O3
          ./create_vertex_ops
          sh scripts/run_vertex.sh radixgraph 4

      - name: Graphalytics benchmarks (RadixGraph)
        run: |
          sh scripts/run_analytics.sh radixgraph 4 4
    
  build_teseo:
    name: Build GFE Driver for Teseo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gcc-11 g++-11 libnuma-dev cmake zlib1g-dev \
            libpapi-dev libjemalloc-dev python3 libtbb-dev libevent-dev libboost-all-dev autoconf automake

      - name: Configure
        run: |
          export CC=gcc-11
          export CXX=g++-11
          git submodule update --init
          mkdir build && cd build
          autoreconf -iv ..

      - name: Compile Teseo library
        run: |
          export CC=gcc-11
          export CXX=g++-11
          git clone https://github.com/cwida/teseo
          cd teseo
          autoreconf -iv
          mkdir build
          cd build
          ../configure --enable-optimize --disable-debug
          make -j2

      - name: Build GFE Driver for Teseo
        run: |
          export CC=gcc-11
          export CXX=g++-11
          cd build
          ../configure --enable-optimize --disable-debug --with-teseo=../teseo/build
          make clean && make -j2

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gfe-teseo-build
          path: |
            build/gfe_driver
            build/Makefile
            teseo/build/libteseo.a
          if-no-files-found: error

  test_teseo:
    name: Test GFE Driver on LiveJournal Dataset (Teseo)
    runs-on: ubuntu-latest
    needs: build_teseo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: gfe-teseo-build
          path: .

      - name: Install runtime dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y g++-11 wget libnuma-dev libtbb-dev libpapi-dev libjemalloc-dev python3 python3-pip
          pip3 install tqdm

      - name: Download LiveJournal dataset
        run: |
          python3 downloader.py --download-lj-only
          sed -i '/^#/d' datasets/*.txt
          sed -i -E 's/[[:space:]]+/ /g' datasets/*.txt
          mv datasets/com-lj.ungraph.txt datasets/com-lj.ungraph.el

      - name: Generate graph properties
        run: |
          g++ scripts/generate_property_files.cpp -o generate_property_files -O2
          ./generate_property_files datasets/com-lj.ungraph.el

      - name: Edge insertions and deletions (Teseo)
        run: |
          chmod +x build/gfe_driver
          sh scripts/run_random.sh teseo.13 4
      
      - name: Vertex insertions and deletions (Teseo)
        run: |
          g++ scripts/create_vertex_ops.cpp -o create_vertex_ops -O3
          ./create_vertex_ops
          sh scripts/run_vertex.sh teseo.13 4

      - name: Graphalytics benchmarks (Teseo)
        run: |
          sh scripts/run_analytics.sh teseo.13 4 4
  
  build_sortledton:
    name: Build GFE Driver for Sortledton
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gcc-11 g++-11 libnuma-dev cmake zlib1g-dev \
            libpapi-dev libjemalloc-dev python3 libtbb-dev libevent-dev libboost-all-dev autoconf automake

      - name: Configure
        run: |
          export CC=gcc-11
          export CXX=g++-11
          git submodule update --init
          mkdir build && cd build
          autoreconf -iv ..

      - name: Compile Sortledton library
        run: |
          export CC=gcc-11
          export CXX=g++-11
          git clone https://gitlab.db.in.tum.de/per.fuchs/sortledton
          cd sortledton
          sed -i '11d' CMakeLists.txt
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make sortledton

      - name: Build GFE Driver for Sortledton
        run: |
          export CC=gcc-11
          export CXX=g++-11
          cd build
          ../configure --enable-optimize --disable-debug --with-sortledton=../sortledton/build
          make clean && make -j2

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gfe-sortledton-build
          path: |
            build/gfe_driver
            build/Makefile
            sortledton/build/libsortledton.a
          if-no-files-found: error

  test_sortledton:
    name: Test GFE Driver on LiveJournal Dataset (Sortledton)
    runs-on: ubuntu-latest
    needs: build_sortledton

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: gfe-sortledton-build
          path: .

      - name: Install runtime dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y g++-11 wget libnuma-dev libtbb-dev libpapi-dev libjemalloc-dev python3 python3-pip
          pip3 install tqdm

      - name: Download LiveJournal dataset
        run: |
          python3 downloader.py --download-lj-only
          sed -i '/^#/d' datasets/*.txt
          sed -i -E 's/[[:space:]]+/ /g' datasets/*.txt
          mv datasets/com-lj.ungraph.txt datasets/com-lj.ungraph.el

      - name: Generate graph properties
        run: |
          g++ scripts/generate_property_files.cpp -o generate_property_files -O2
          ./generate_property_files datasets/com-lj.ungraph.el

      - name: Edge insertions and deletions (Sortledton)
        run: |
          chmod +x build/gfe_driver
          sh scripts/run_random.sh sortledton.4 4
      
      - name: Vertex insertions and deletions (Sortledton)
        run: |
          g++ scripts/create_vertex_ops.cpp -o create_vertex_ops -O3
          ./create_vertex_ops
          sh scripts/run_vertex.sh sortledton.4 4

      - name: Graphalytics benchmarks (Sortledton)
        run: |
          sh scripts/run_analytics.sh sortledton.4 4 4
      
  build_spruce:
    name: Build GFE Driver for Spruce
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gcc-11 g++-11 libnuma-dev cmake zlib1g-dev \
            libpapi-dev libjemalloc-dev python3 libtbb-dev libevent-dev libboost-all-dev autoconf automake

      - name: Configure
        run: |
          export CC=gcc-11
          export CXX=g++-11
          git submodule update --init
          mkdir build && cd build
          autoreconf -iv ..

      - name: Download Spruce library
        run: |
          export CC=gcc-11
          export CXX=g++-11
          wget -c https://github.com/Stardust-SJF/gfe_driver/releases/download/v2.0.0/libBVGT_stable.a
          mv libBVGT_stable.a libBVGT.a
      
      - name: Build junction dependency
        run: |
          export CC=gcc-11
          export CXX=g++-11
          git clone https://github.com/preshing/junction.git
          git clone https://github.com/preshing/turf.git
          cd junction
          mkdir build && cd build
          cmake -DJUNCTION_WITH_SAMPLES=OFF ..
          sudo make install

      - name: Build GFE Driver for Spruce
        run: |
          export CC=gcc-11
          export CXX=g++-11
          cd build
          ../configure --enable-optimize --disable-debug --with-bvgt=../
          make clean && make -j2

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gfe-spruce-build
          path: |
            build/gfe_driver
            build/Makefile
            libBVGT.a
          if-no-files-found: error

  test_spruce:
    name: Test GFE Driver on LiveJournal Dataset (Spruce)
    runs-on: ubuntu-latest
    needs: build_spruce

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: gfe-spruce-build
          path: .

      - name: Install runtime dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y g++-11 wget libnuma-dev libtbb-dev libpapi-dev libjemalloc-dev python3 python3-pip
          pip3 install tqdm

      - name: Download LiveJournal dataset
        run: |
          python3 downloader.py --download-lj-only
          sed -i '/^#/d' datasets/*.txt
          sed -i -E 's/[[:space:]]+/ /g' datasets/*.txt
          mv datasets/com-lj.ungraph.txt datasets/com-lj.ungraph.el

      - name: Generate graph properties
        run: |
          g++ scripts/generate_property_files.cpp -o generate_property_files -O2
          ./generate_property_files datasets/com-lj.ungraph.el

      - name: Edge insertions and deletions (Spruce)
        run: |
          chmod +x build/gfe_driver
          sh scripts/run_random.sh bvgt 4
      
      - name: Vertex insertions and deletions (Spruce)
        run: |
          g++ scripts/create_vertex_ops.cpp -o create_vertex_ops -O3
          ./create_vertex_ops
          sh scripts/run_vertex.sh bvgt 4

      - name: Graphalytics benchmarks (Spruce)
        run: |
          sh scripts/run_analytics.sh bvgt 4 4
    
  build_gtx:
    name: Build GFE Driver for GTX
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gcc-11 g++-11 libnuma-dev cmake zlib1g-dev \
            libpapi-dev libjemalloc-dev python3 libtbb-dev libevent-dev libboost-all-dev autoconf automake

      - name: Configure
        run: |
          export CC=gcc-11
          export CXX=g++-11
          git submodule update --init
          mkdir build && cd build
          autoreconf -iv ..

      - name: Compile GTX library
        run: |
          export CC=gcc-11
          export CXX=g++-11
          git clone https://github.com/Jiboxiake/GTX-SIGMOD2025
          cd GTX-SIGMOD2025
          git submodule update --init --recursive
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j

      - name: Build GFE Driver for GTX
        run: |
          export CC=gcc-11
          export CXX=g++-11
          cd build
          ../configure --enable-optimize --disable-debug --with-gtx=../GTX-SIGMOD2025/build
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:../GTX-SIGMOD2025/build
          make clean && make -j2

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gfe-gtx-build
          path: |
            build/gfe_driver
            build/Makefile
            GTX-SIGMOD2025/build/libgtx.so
          if-no-files-found: error

  test_gtx:
    name: Test GFE Driver on LiveJournal Dataset (GTX)
    runs-on: ubuntu-latest
    needs: build_gtx

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: gfe-gtx-build
          path: .

      - name: Install runtime dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y g++-11 wget libnuma-dev libtbb-dev libpapi-dev libjemalloc-dev python3 python3-pip
          pip3 install tqdm

      - name: Download LiveJournal dataset
        run: |
          python3 downloader.py --download-lj-only
          sed -i '/^#/d' datasets/*.txt
          sed -i -E 's/[[:space:]]+/ /g' datasets/*.txt
          mv datasets/com-lj.ungraph.txt datasets/com-lj.ungraph.el

      - name: Generate graph properties
        run: |
          g++ scripts/generate_property_files.cpp -o generate_property_files -O2
          ./generate_property_files datasets/com-lj.ungraph.el

      - name: Edge insertions and deletions (GTX)
        run: |
          chmod +x build/gfe_driver
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:./GTX-SIGMOD2025/build
          sh scripts/run_random.sh gtx 4
      
      - name: Vertex insertions and deletions (GTX)
        run: |
          g++ scripts/create_vertex_ops.cpp -o create_vertex_ops -O3
          ./create_vertex_ops
          sh scripts/run_vertex.sh gtx 4

      - name: Graphalytics benchmarks (GTX)
        run: |
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:./GTX-SIGMOD2025/build
          sh scripts/run_analytics.sh gtx 4 4